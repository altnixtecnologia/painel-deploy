<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MagiaTV - Status e Renovação</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { background-color: #0f0f13; color: #e2e2e2; font-family: 'Inter', sans-serif; }
        .card { background: #181823; border-radius: 16px; border: 1px solid #2d2d3f; }
        .btn-pix { background: #00ffa3; color: #000; font-weight: 800; transition: 0.3s; cursor: pointer; }
        .btn-pix:hover { background: #00d689; transform: scale(1.02); }
        .badge-prata { background: #94a3b8; color: #0f172a; }
        .badge-diamante { background: #06b6d4; color: #fff; }
        .animate-fade { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="p-4 flex justify-center min-h-screen">
    <div id="app" class="w-full max-w-md">
        <div id="loader" class="text-center mt-20">
            <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-cyan-500 mx-auto"></div>
            <p class="mt-4 text-gray-500 text-sm italic">Conectando aos servidores Altnix...</p>
        </div>

        <div id="content" class="hidden animate-fade">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-black text-white italic tracking-tighter">MAGIA<span class="text-cyan-500">TV</span></h1>
                <div id="serverBadge" class="inline-block px-3 py-1 rounded-full text-[10px] font-bold mt-2 uppercase"></div>
            </div>

            <div class="card p-6 mb-6 shadow-2xl">
                <p class="text-gray-500 text-[10px] uppercase tracking-widest mb-1">Assinante</p>
                <h2 id="clientName" class="text-2xl font-bold text-white mb-4">--</h2>
                
                <div class="flex justify-between items-center p-3 bg-black/40 rounded-xl mb-6">
                    <div>
                        <p class="text-[9px] text-gray-500 uppercase">Seu Magia ID</p>
                        <p id="magiaId" class="font-mono text-cyan-400 font-bold text-lg tracking-wider">--</p>
                    </div>
                    <button onclick="copyText('magiaId')" class="bg-cyan-500/10 text-cyan-400 px-3 py-2 rounded-lg text-[10px] font-bold border border-cyan-500/20 active:scale-95 transition">Copiar ID</button>
                </div>

                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-400">App Launcher</span>
                        <span id="lStatus" class="text-xs font-bold px-3 py-1 rounded-full">--</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-400">Canais e VOD</span>
                        <span id="tStatus" class="text-xs font-bold px-3 py-1 rounded-full">--</span>
                    </div>
                </div>
            </div>

            <div class="card p-6 mb-10">
                <h3 class="text-white font-bold mb-6 flex items-center gap-2">
                    <span class="text-xl">⚡</span> Planos de Renovação
                </h3>
                <div id="plansContainer" class="space-y-3"></div>

                <div id="pixArea" class="hidden mt-8 p-5 bg-black/50 rounded-2xl border border-dashed border-cyan-500/30 animate-fade">
                    <div class="flex justify-between items-center mb-4">
                        <p class="text-xs font-bold text-cyan-500 uppercase">Pagamento via PIX</p>
                        <span id="selectedPlanLabel" class="text-[10px] text-gray-500"></span>
                    </div>
                    <textarea id="pixCode" readonly class="w-full bg-black/40 text-[10px] p-3 rounded-lg text-gray-400 h-24 mb-4 border border-white/5 resize-none focus:outline-none"></textarea>
                    <button onclick="copyPix()" class="w-full btn-pix py-4 rounded-xl mb-3 shadow-lg shadow-green-500/20 active:scale-95 transition">COPIAR CÓDIGO PIX</button>
                    <button onclick="avisoWhats()" class="w-full bg-white/5 text-gray-300 py-3 rounded-xl text-xs font-bold border border-white/10 hover:bg-white/10 transition">JÁ PAGUEI, ENVIAR COMPROVANTE</button>
                </div>
            </div>
            <p class="text-center text-[10px] text-gray-600 mb-10 uppercase tracking-widest">Altnix Tecnologia • Florianópolis/SC</p>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://yftikqosmgpfzoacrwxz.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlmdGlrcW9zbWdwZnpvYWNyd3h6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5OTgzMDksImV4cCI6MjA3NjU3NDMwOX0.mcIm3auQNIfPw_CZ9tEqBxfU-Rj3Yl5BNzzyGyhfI2o';
        const CHAVE_PIX = 'altnixtecnologia@gmail.com';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let clientData = null;
        let supportPhone = "5548991004780";

        async function init() {
            const params = new URLSearchParams(window.location.search);
            const token = params.get('t');
            if (!token) return showError("Link inválido.");

            try {
                const { data: client, error } = await _supabase.from('launcher_config').select('*').eq('status_token', token).single();
                if (error || !client) throw "Acesso não encontrado.";
                clientData = client;

                const { data: plans } = await _supabase.from('magia_plans').select('*').eq('server_type', client.server_type).order('price', { ascending: true });
                renderPage(client, plans || []);
            } catch (err) { showError(err); }
        }

        function renderPage(client, plans) {
            document.getElementById('clientName').innerText = client.client_name;
            document.getElementById('magiaId').innerText = client.magia_id;
            const sBadge = document.getElementById('serverBadge');
            sBadge.innerText = `Servidor ${client.server_type}`;
            sBadge.classList.add(client.server_type === 'Diamante' ? 'badge-diamante' : 'badge-prata');

            renderStatus('lStatus', client.launcher_expiration_date);
            renderStatus('tStatus', client.tv_expiration_date);

            const container = document.getElementById('plansContainer');
            plans.forEach(plan => {
                let finalPrice = (plan.plan_name === 'Mensal' && client.custom_price) ? client.custom_price : plan.price;
                const btn = document.createElement('button');
                btn.className = "w-full p-4 card hover:bg-white/5 transition flex justify-between items-center group active:scale-95";
                btn.onclick = () => showPix(finalPrice, plan.plan_name);
                btn.innerHTML = `
                    <div class="text-left"><span class="text-sm font-bold text-white">${plan.plan_name}</span></div>
                    <div class="text-right"><p class="text-cyan-400 font-black">R$ ${parseFloat(finalPrice).toFixed(2).replace('.', ',')}</p></div>`;
                container.appendChild(btn);
            });
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('content').classList.remove('hidden');
        }

        function renderStatus(id, dateStr) {
            const el = document.getElementById(id);
            if (!dateStr) { el.innerText = "PENDENTE"; el.classList.add('text-gray-500'); return; }
            const date = new Date(dateStr);
            const diff = (date - new Date()) / (1000 * 60 * 60 * 24);
            el.innerText = date.toLocaleDateString('pt-BR');
            el.classList.add(diff < 0 ? 'text-red-500' : (diff <= 5 ? 'text-orange-500' : 'text-green-500'));
        }

        function showPix(valor, plano) {
            window.planoSel = plano; window.valorSel = valor;
            document.getElementById('pixArea').classList.remove('hidden');
            document.getElementById('selectedPlanLabel').innerText = `PLANO ${plano.toUpperCase()}`;
            
            const valorStr = valor.toFixed(2);
            let pix = "00020101021226";
            let merchant = `0014br.gov.bcb.pix01${CHAVE_PIX.length}${CHAVE_PIX}`;
            pix += `${merchant.length}${merchant}520400005303986540${valorStr.length}${valorStr}5802BR5917ALTNIX TECNOLOGIA6008FLORIPA62070503***6304`;

            const crc16 = (str) => {
                let crc = 0xFFFF;
                for (let i = 0; i < str.length; i++) {
                    crc ^= str.charCodeAt(i) << 8;
                    for (let j = 0; j < 8; j++) crc = (crc & 0x8000) ? (crc << 1) ^ 0x1021 : (crc << 1);
                }
                return (crc & 0xFFFF).toString(16).toUpperCase().padStart(4, '0');
            };

            document.getElementById('pixCode').value = pix + crc16(pix);
            document.getElementById('pixArea').scrollIntoView({ behavior: 'smooth' });
        }

        function copyPix() {
            const c = document.getElementById('pixCode'); c.select();
            navigator.clipboard.writeText(c.value); alert("Copiado! Pague no app do banco.");
        }

        function avisoWhats() {
            const msg = `Olá! Paguei o plano ${window.planoSel} (R$ ${window.valorSel}) para o Magia ID ${clientData.magia_id}. Segue o comprovante!`;
            window.open(`https://wa.me/${supportPhone}?text=${encodeURIComponent(msg)}`);
        }

        function showError(msg) { document.getElementById('loader').innerHTML = `<p class="text-red-500 font-bold">${msg}</p>`; }
        init();
    </script>
</body>
</html>